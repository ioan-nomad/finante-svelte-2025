<!DOCTYPE html>
<html lang="ro">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>N-OMAD Suite - Test Runner</title>
</head>
<body>
  <h1>N-OMAD Suite - Integration Test Runner</h1>
  <p>Deschide Developer Console (F12) pentru a vedea rezultatele testelor.</p>

  <script type="module">
    console.log('ğŸ”¬ N-OMAD Suite Enhanced Test Runner Starting...');

    // Import new testing infrastructure
    let TestRunner, TestUtils;
    try {
      const testRunnerModule = await import('./src/lib/testing/testRunner.js');
      const testUtilsModule = await import('./src/lib/testing/testUtils.js');
      TestRunner = testRunnerModule.TestRunner;
      TestUtils = testUtilsModule.default;
      console.log('âœ… Advanced testing infrastructure loaded');
    } catch (error) {
      console.warn('âš ï¸ Advanced testing infrastructure not available:', error.message);
    }

    // Test 1: Check Module Loading
    async function testModules() {
      console.log('\nğŸ“¦ Testing Module Loading...');

      try {
        const modules = [
          './src/modules/nutrition/analytics/AnalyticsEngine.js',
          './src/modules/testing/IntegrationTester.js',
          './src/lib/testing/testRunner.js',
          './src/lib/testing/testUtils.js'
        ];

        for (const path of modules) {
          const module = await import(path);
          console.log(`âœ… Loaded: ${path}`);
        }

        return true;
      } catch (error) {
        console.error('âŒ Module loading failed:', error);
        return false;
      }
    }

    // Test 2: Run Advanced Unit Tests
    async function runAdvancedTests() {
      if (!TestRunner) {
        console.log('\nâš ï¸ Skipping advanced tests - TestRunner not available');
        return null;
      }

      console.log('\nğŸ§ª Running Advanced Test Suite...');

      const runner = new TestRunner();
      const results = await runner.runAllTests();

      return results;
    }

    // Test 3: Run Integration Tests
    async function runIntegrationTests() {
      console.log('\nğŸ”§ Running Integration Tests...');

      try {
        const { integrationTester } = await import('./src/modules/testing/IntegrationTester.js');

        // Check production readiness
        const readiness = await integrationTester.checkProductionReadiness();

        console.log('\nğŸ“Š Production Readiness Check:');
        console.log(`Score: ${readiness.score}%`);
        console.log(`Ready: ${readiness.ready ? 'âœ… YES' : 'âŒ NO'}`);

        readiness.checks.forEach(check => {
          console.log(`${check.status} ${check.name}`);
        });

        return readiness;
      } catch (error) {
        console.error('âŒ Integration tests failed:', error);
        return null;
      }
    }

    // Test 4: Performance & Security Tests
    async function runPerformanceTests() {
      if (!TestUtils) {
        console.log('\nâš ï¸ Skipping performance tests - TestUtils not available');
        return;
      }

      console.log('\nâš¡ Running Performance & Security Tests...');

      // Test localStorage performance
      const perfResult = await TestUtils.measurePerformance(() => {
        localStorage.setItem('test', JSON.stringify({ data: 'test' }));
        localStorage.getItem('test');
        localStorage.removeItem('test');
      }, 100);

      console.log(`ğŸ“ˆ localStorage Performance: ${perfResult.avg.toFixed(2)}ms avg (${perfResult.iterations} iterations)`);

      // Test XSS vulnerability
      const xssTests = [
        '<script>alert("xss")</script>',
        'javascript:alert("xss")',
        '<img src=x onerror=alert("xss")>'
      ];

      console.log('\nğŸ”’ Security Tests:');
      xssTests.forEach(test => {
        const isVulnerable = TestUtils.testXSSVulnerability(test);
        console.log((isVulnerable ? 'âš ï¸' : 'âœ…') + ' XSS Test: ' + test.substring(0, 20) + '...');
      });
    }

    // Test 5: Check localStorage Data
    function checkLocalStorage() {
      console.log('\nğŸ’¾ Checking localStorage...');

      const keys = [
        'groceryInventory',
        'nutritionProfile',
        'mtor_cycles',
        'generated_recipes',
        'meal_history',
        'fs_data'
      ];

      keys.forEach(key => {
        const data = localStorage.getItem(key);
        if (data) {
          try {
            const parsed = JSON.parse(data);
            const size = new Blob([data]).size;
            console.log(`âœ… ${key}: ${(size / 1024).toFixed(2)} KB`);
          } catch {
            console.log(`âš ï¸ ${key}: Invalid JSON`);
          }
        } else {
          console.log(`âŒ ${key}: Not found`);
        }
      });
    }

    // Run all tests
    async function runAllTests() {
      console.log('â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•');
      console.log('   N-OMAD SUITE - ENHANCED TEST SUITE   ');
      console.log('â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•');

      const startTime = Date.now();

      await testModules();
      const advancedResults = await runAdvancedTests();
      checkLocalStorage();
      const integrationResults = await runIntegrationTests();
      await runPerformanceTests();

      const duration = Date.now() - startTime;

      console.log('\nâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•');
      console.log(`â±ï¸ Total Test Duration: ${duration}ms`);

      // Overall status
      const allPassed = integrationResults?.ready &&
                       (!advancedResults || advancedResults.failed === 0);

      if (allPassed) {
        console.log('ğŸ‰ ALL TESTS PASSED! Production Ready!');
      } else {
        console.log('âš ï¸ Some tests failed. Review results above.');
      }
      console.log('â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•');

      // Make results available globally for manual inspection
      window.testResults = {
        integration: integrationResults,
        advanced: advancedResults,
        duration,
        passed: allPassed
      };

      console.log('\nğŸ’¡ Test results available at: window.testResults');
    }

    // Auto-run tests
    runAllTests();
  </script>
</body>
</html>